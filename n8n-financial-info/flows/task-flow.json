{
  "name": "Workflow 1",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        256,
        -112
      ],
      "id": "64e2a209-c101-422b-bbf9-4aab1f13364a",
      "name": "Schedule Trigger"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1Gav5wJnn-w-SffIATp_OVKfDdiIbE3AIPqxvZD8_zTI",
          "mode": "list",
          "cachedResultName": "Stock-info",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Gav5wJnn-w-SffIATp_OVKfDdiIbE3AIPqxvZD8_zTI/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 865796428,
          "mode": "list",
          "cachedResultName": "2",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Gav5wJnn-w-SffIATp_OVKfDdiIbE3AIPqxvZD8_zTI/edit#gid=865796428"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        464,
        -112
      ],
      "id": "ad9951ba-962b-4d21-82b7-f9e22274763d",
      "name": "GetTasks",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "TcsAIidzUoiqPfyA",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1Gav5wJnn-w-SffIATp_OVKfDdiIbE3AIPqxvZD8_zTI",
          "mode": "list",
          "cachedResultName": "Stock-info",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Gav5wJnn-w-SffIATp_OVKfDdiIbE3AIPqxvZD8_zTI/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 136723104,
          "mode": "list",
          "cachedResultName": "executions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Gav5wJnn-w-SffIATp_OVKfDdiIbE3AIPqxvZD8_zTI/edit#gid=136723104"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        672,
        -112
      ],
      "id": "092d8588-6e9d-45e6-bae2-62e7bd9bb6a6",
      "name": "GetExecutions",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "TcsAIidzUoiqPfyA",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const ScheduleType = {\n  DAILY: 'DAILY',\n  WEEKLY: 'WEEKLLY',\n  MOUNTHLY: 'MONTLY'\n};\n\nconst DaysOfWeek = {\n  Sunday: 0,\n  Monday: 1,\n  Tuesday: 2,\n  Wednesday: 3,\n  Thursday: 4,\n  Friday: 5,\n  Saturday: 6\n};\n\nfunction parseExecutionDate(dateStr) {\n  const [datePart, timePart] = dateStr.split(' ');\n  const [day, month, year] = datePart.split('/');\n  const [hours, minutes, seconds] = timePart.split(':');\n  return new Date(year, month - 1, day, hours, minutes, seconds);\n}\n\nfunction isToday(date, today = new Date()) {\n  return date.getDate() === today.getDate() &&\n         date.getMonth() === today.getMonth() &&\n         date.getFullYear() === today.getFullYear();\n}\n\nfunction getLastExecution(taskId, executions) {\n  const taskExecutions = executions\n    .filter(exec => exec.Id === taskId)\n    .map(exec => parseExecutionDate(exec.ExecutionTime))\n    .sort((a, b) => b - a);\n  \n  return taskExecutions.length > 0 ? taskExecutions[0] : null;\n}\n\nfunction getLastNExecutions(taskId, executions, n = 3) {\n  const taskExecutions = executions\n    .filter(exec => exec.Id === taskId)\n    .map(exec => ({\n      date: parseExecutionDate(exec.ExecutionTime),\n      dateStr: exec.ExecutionTime,\n      output: exec.Saida\n    }))\n    .sort((a, b) => b.date - a.date)\n    .slice(0, n);\n  \n  return taskExecutions;\n}\n\nfunction shouldExecuteDaily(task, lastExecution, today) {\n  if (!lastExecution) return true;\n  if (!isToday(lastExecution, today)) return true;\n  \n  if (task.ScheduledPeriod > 1) {\n    const daysDiff = Math.floor((today - lastExecution) / (1000 * 60 * 60 * 24));\n    return daysDiff >= task.ScheduledPeriod;\n  }\n  \n  return false;\n}\n\nfunction shouldExecuteWeekly(task, lastExecution, today) {\n  const scheduledDayOfWeek = DaysOfWeek[task.ScheduledDay];\n  const todayDayOfWeek = today.getDay();\n  \n  if (scheduledDayOfWeek !== todayDayOfWeek) return false;\n  if (!lastExecution) return true;\n  \n  if (!isToday(lastExecution, today)) {\n    const weeksDiff = Math.floor((today - lastExecution) / (1000 * 60 * 60 * 24 * 7));\n    return weeksDiff >= task.ScheduledPeriod;\n  }\n  \n  return false;\n}\n\nfunction shouldExecuteMOUNTHLY(task, lastExecution, today) {\n  const scheduledDayOfMonth = parseInt(task.ScheduledDay);\n  const todayDayOfMonth = today.getDate();\n  \n  if (scheduledDayOfMonth !== todayDayOfMonth) return false;\n  if (!lastExecution) return true;\n  \n  if (!isToday(lastExecution, today)) {\n    const monthsDiff = (today.getFullYear() - lastExecution.getFullYear()) * 12 \n                     + (today.getMonth() - lastExecution.getMonth());\n    return monthsDiff >= task.ScheduledPeriod;\n  }\n  \n  return false;\n}\n\nfunction shouldExecuteTask(task, lastExecution, today = new Date()) {\n  switch (task.ScheduledType) {\n    case ScheduleType.DAILY:\n      return shouldExecuteDaily(task, lastExecution, today);\n    case ScheduleType.WEEKLY:\n      return shouldExecuteWeekly(task, lastExecution, today);\n    case ScheduleType.MOUNTHLY:\n      return shouldExecuteMOUNTHLY(task, lastExecution, today);\n    default:\n      return false;\n  }\n}\n\nfunction buildPromptWithHistory(task, lastExecutions) {\n  let prompt = task.Prompt;\n  \n  if (lastExecutions.length > 0) {\n    prompt += '\\n\\n---\\n\\n';\n    prompt += 'ðŸ“‹ HISTÃ“RICO DAS ÃšLTIMAS EXECUÃ‡Ã•ES:\\n';\n    prompt += 'Para evitar repetiÃ§Ã£o, considere as respostas anteriores abaixo:\\n\\n';\n    \n    lastExecutions.forEach((exec, index) => {\n      prompt += `${index + 1}. ExecuÃ§Ã£o em ${exec.dateStr}:\\n`;\n      prompt += `${exec.output}\\n\\n`;\n    });\n    \n    prompt += 'âš ï¸ IMPORTANTE: Gere uma resposta diferente e criativa, evitando repetir as ideias acima.';\n  }\n  \n  return prompt;\n}\n\n// Acessar nodes usando $() syntax\nconst tasksItems = $('GetTasks').all();\nconst executionsItems = $('GetExecutions').all();\n\n// Extrair dados JSON\nconst tasks = tasksItems.map(item => item.json);\nconst executions = executionsItems.map(item => item.json);\n\n// Data de hoje\nconst today = new Date();\n\nconsole.log(`ðŸ“… Verificando tasks para: ${today.toLocaleDateString('pt-BR')}`);\nconsole.log(`ðŸ“Š Total de tasks: ${tasks.length}`);\nconsole.log(`ðŸ“Š Total de execuÃ§Ãµes: ${executions.length}`);\n\n// Filtrar tasks que devem ser executadas hoje\nconst tasksToExecute = tasks.filter(task => {\n  const lastExecution = getLastExecution(task.Id, executions);\n  const shouldExecute = shouldExecuteTask(task, lastExecution, today);\n  \n  if (shouldExecute) {\n    console.log(`âœ… Task \"${task.Subject}\" deve ser executada`);\n  }\n  \n  return shouldExecute;\n});\n\nconsole.log(`\\nðŸŽ¯ Total de tasks para executar: ${tasksToExecute.length}`);\n\n// Enriquecer cada task com histÃ³rico das Ãºltimas 3 execuÃ§Ãµes\nconst tasksWithHistory = tasksToExecute.map(task => {\n  const lastExecutions = getLastNExecutions(task.Id, executions, 3);\n  const enrichedPrompt = buildPromptWithHistory(task, lastExecutions);\n  \n  console.log(`\\nðŸ“ Task \"${task.Subject}\" - HistÃ³rico: ${lastExecutions.length} execuÃ§Ãµes anteriores`);\n  \n  return {\n    ...task,\n    Prompt: enrichedPrompt,\n    HistoryCount: lastExecutions.length\n  };\n});\n\n// Retornar no formato n8n\nreturn tasksWithHistory.map((task, index) => ({\n  json: task,\n  pairedItem: { item: index }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        880,
        -112
      ],
      "id": "98e27daa-6b97-4e05-a082-f2cbac3c0c47",
      "name": "FilterTasksToBeExecuted"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash",
          "mode": "list",
          "cachedResultName": "models/gemini-2.5-flash"
        },
        "messages": {
          "values": [
            {
              "content": "={{ $json.Prompt }}"
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [
        1088,
        -112
      ],
      "id": "752ad0fb-1ae7-45e7-ab42-50baddbb46cf",
      "name": "AI-Process",
      "credentials": {
        "googlePalmApi": {
          "id": "xg8JJT12sq4nKGDw",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1Gav5wJnn-w-SffIATp_OVKfDdiIbE3AIPqxvZD8_zTI",
          "mode": "list",
          "cachedResultName": "Stock-info",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Gav5wJnn-w-SffIATp_OVKfDdiIbE3AIPqxvZD8_zTI/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 136723104,
          "mode": "list",
          "cachedResultName": "executions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Gav5wJnn-w-SffIATp_OVKfDdiIbE3AIPqxvZD8_zTI/edit#gid=136723104"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Id": "={{ $('FilterTasksToBeExecuted').item.json.Id }}",
            "ExecutionTime": "={{ $now.format('dd/MM/yyyy HH:mm:ss') }}",
            "Saida": "={{ $json.content.parts[0].text }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "Id",
              "displayName": "Id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ExecutionTime",
              "displayName": "ExecutionTime",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Saida",
              "displayName": "Saida",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1424,
        -112
      ],
      "id": "bb46f269-ef54-46f3-a4d8-e43c9cfb0b9c",
      "name": "AppendExecutions",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "TcsAIidzUoiqPfyA",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "sendTo": "ldias.rs@gmail.com",
        "subject": "={{ $('FilterTasksToBeExecuted').item.json.Subject }}",
        "message": "={{ $('AI-Process').item.json.content.parts[0].text }}",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        1632,
        -112
      ],
      "id": "231eb908-a4b0-4cb6-aed7-edca5af80c50",
      "name": "Send a message",
      "webhookId": "9d836195-3a6d-48a7-a95f-ef9a5c055267",
      "credentials": {
        "gmailOAuth2": {
          "id": "Mx40O4DWSK5YGsKn",
          "name": "Gmail account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "GetTasks",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GetTasks": {
      "main": [
        [
          {
            "node": "GetExecutions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GetExecutions": {
      "main": [
        [
          {
            "node": "FilterTasksToBeExecuted",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FilterTasksToBeExecuted": {
      "main": [
        [
          {
            "node": "AI-Process",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI-Process": {
      "main": [
        [
          {
            "node": "AppendExecutions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AppendExecutions": {
      "main": [
        [
          {
            "node": "Send a message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false,
    "errorWorkflow": "HOB5DNjfjjnwHLUg",
    "executionTimeout": 3600,
    "timeSavedPerExecution": 30
  },
  "versionId": "f7d19405-8342-46ba-b263-601ad3ba24ce",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "c4d6a8d4fd80a8d9138c380c50a14cd195951e4a2b31f687a6d6dc7a33dd0c5c"
  },
  "id": "HOB5DNjfjjnwHLUg",
  "tags": []
}