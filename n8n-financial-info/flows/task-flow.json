{
  "name": "Workflow 1",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -1136,
        -16
      ],
      "id": "ea24342b-3191-4e13-906c-66327b9ea750",
      "name": "Schedule Trigger"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1Gav5wJnn-w-SffIATp_OVKfDdiIbE3AIPqxvZD8_zTI",
          "mode": "list",
          "cachedResultName": "n8n-database",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Gav5wJnn-w-SffIATp_OVKfDdiIbE3AIPqxvZD8_zTI/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 865796428,
          "mode": "list",
          "cachedResultName": "2",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Gav5wJnn-w-SffIATp_OVKfDdiIbE3AIPqxvZD8_zTI/edit#gid=865796428"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -928,
        -16
      ],
      "id": "cd110cf7-0444-4be6-b560-683c09635376",
      "name": "GetTasks",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "TcsAIidzUoiqPfyA",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1Gav5wJnn-w-SffIATp_OVKfDdiIbE3AIPqxvZD8_zTI",
          "mode": "list",
          "cachedResultName": "n8n-database",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Gav5wJnn-w-SffIATp_OVKfDdiIbE3AIPqxvZD8_zTI/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 136723104,
          "mode": "list",
          "cachedResultName": "executions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Gav5wJnn-w-SffIATp_OVKfDdiIbE3AIPqxvZD8_zTI/edit#gid=136723104"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -720,
        -16
      ],
      "id": "75e87e68-85f7-402a-97ad-0ba2a8aee037",
      "name": "GetExecutions",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "TcsAIidzUoiqPfyA",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const ScheduleType = {\n  DAILY: 'DAILY',\n  WEEKLY: 'WEEKLY',\n  MONTHLY: 'MOUNTHLY'\n};\n\nconst DaysOfWeek = {\n  Sunday: 0,\n  Monday: 1,\n  Tuesday: 2,\n  Wednesday: 3,\n  Thursday: 4,\n  Friday: 5,\n  Saturday: 6\n};\n\n\nfunction parseExecutionDate(dateStr) {\n  const [datePart, timePart] = dateStr.split(' ');\n  const [day, month, year] = datePart.split('/');\n  const [hours, minutes, seconds] = timePart.split(':');\n  return new Date(year, month - 1, day, hours, minutes, seconds);\n}\n\n\nfunction isToday(date, today = new Date()) {\n  return date.getDate() === today.getDate() &&\n         date.getMonth() === today.getMonth() &&\n         date.getFullYear() === today.getFullYear();\n}\n\n\nfunction getLastExecution(taskId, executions) {\n  const taskExecutions = executions\n    .filter(exec => exec.Id === taskId)\n    .map(exec => parseExecutionDate(exec.ExecutionTime))\n    .sort((a, b) => b - a);\n  \n  return taskExecutions.length > 0 ? taskExecutions[0] : null;\n}\n\n\nfunction getLastNExecutions(taskId, executions, n = 3) {\n  const taskExecutions = executions\n    .filter(exec => exec.Id === taskId)\n    .map(exec => ({\n      date: parseExecutionDate(exec.ExecutionTime),\n      dateStr: exec.ExecutionTime,\n      output: exec.Saida\n    }))\n    .sort((a, b) => b.date - a.date)\n    .slice(0, n);\n  \n  return taskExecutions;\n}\n\n\nfunction hasScheduledTimePassed(scheduledTime, currentTime) {\n  if (!scheduledTime) return true; // Se nÃ£o tem horÃ¡rio definido, sempre pode executar\n  \n  const [scheduledHours, scheduledMinutes] = scheduledTime.split(':').map(Number);\n  const currentHours = currentTime.getHours();\n  const currentMinutes = currentTime.getMinutes();\n  \n  // Compara horÃ¡rio\n  if (currentHours > scheduledHours) return true;\n  if (currentHours === scheduledHours && currentMinutes >= scheduledMinutes) return true;\n  \n  return false;\n}\n\n\nfunction shouldExecuteDaily(task, lastExecution, today) {\n  if (!lastExecution) return true;\n  \n  // Se jÃ¡ executou hoje, nÃ£o executar\n  if (isToday(lastExecution, today)) return false;\n  \n  // Se tem perÃ­odo maior que 1, verificar se passou o nÃºmero de dias\n  if (task.ScheduledPeriod > 1) {\n    const daysDiff = Math.floor((today - lastExecution) / (1000 * 60 * 60 * 24));\n    return daysDiff >= task.ScheduledPeriod;\n  }\n  \n  // PerÃ­odo = 1, executar diariamente\n  return true;\n}\n\n\nfunction shouldExecuteWeekly(task, lastExecution, today) {\n  const scheduledDayOfWeek = DaysOfWeek[task.ScheduledDay];\n  const todayDayOfWeek = today.getDay();\n  \n  // NÃ£o Ã© o dia da semana correto\n  if (scheduledDayOfWeek !== todayDayOfWeek) return false;\n  \n  // Verifica se o horÃ¡rio jÃ¡ passou\n  if (!hasScheduledTimePassed(task.ScheduledTime, today)) return false;\n  \n  // Nunca executou antes - pode executar\n  if (!lastExecution) return true;\n  \n  // JÃ¡ executou hoje - nÃ£o executar novamente\n  if (isToday(lastExecution, today)) return false;\n  \n  // Executou em outro dia - verifica o perÃ­odo\n  const weeksDiff = Math.floor((today - lastExecution) / (1000 * 60 * 60 * 24 * 7));\n  return weeksDiff >= task.ScheduledPeriod;\n}\n\n\nfunction shouldExecuteMonthly(task, lastExecution, today) {\n  const scheduledDayOfMonth = parseInt(task.ScheduledDay);\n  const todayDayOfMonth = today.getDate();\n  \n  // NÃ£o Ã© o dia do mÃªs correto\n  if (scheduledDayOfMonth !== todayDayOfMonth) return false;\n  \n  // Verifica se o horÃ¡rio jÃ¡ passou\n  if (!hasScheduledTimePassed(task.ScheduledTime, today)) return false;\n  \n  // Nunca executou antes - pode executar\n  if (!lastExecution) return true;\n  \n  // JÃ¡ executou hoje - nÃ£o executar novamente\n  if (isToday(lastExecution, today)) return false;\n  \n  // Executou em outro dia - verifica o perÃ­odo\n  const monthsDiff = (today.getFullYear() - lastExecution.getFullYear()) * 12 \n                   + (today.getMonth() - lastExecution.getMonth());\n  return monthsDiff >= task.ScheduledPeriod;\n}\n\n\nfunction shouldExecuteTask(task, lastExecution, today = new Date()) {\n  switch (task.ScheduledType) {\n    case ScheduleType.DAILY:\n      return shouldExecuteDaily(task, lastExecution, today);\n    case ScheduleType.WEEKLY:\n      return shouldExecuteWeekly(task, lastExecution, today);\n    case ScheduleType.MONTHLY:\n      return shouldExecuteMonthly(task, lastExecution, today);\n    default:\n      return false;\n  }\n}\n\n\nfunction buildPromptWithHistory(task, lastExecutions) {\n  let prompt = task.Prompt;\n  \n  if (lastExecutions.length > 0) {\n    prompt += '\\n\\n---\\n\\n';\n    prompt += 'ðŸ“‹ HISTÃ“RICO DAS ÃšLTIMAS EXECUÃ‡Ã•ES:\\n';\n    prompt += 'Para evitar repetiÃ§Ã£o, considere as respostas anteriores abaixo:\\n\\n';\n    \n    lastExecutions.forEach((exec, index) => {\n      prompt += `${index + 1}. ExecuÃ§Ã£o em ${exec.dateStr}:\\n`;\n      prompt += `${exec.output}\\n\\n`;\n    });\n    \n    prompt += 'âš ï¸ IMPORTANTE: Gere uma resposta diferente e criativa, evitando repetir as ideias acima.';\n  }\n  \n  return prompt;\n}\n\n\nfunction removeDuplicateEmails(emails) {\n  return emails.filter((email, index, self) => self.indexOf(email) === index);\n}\n\n\nfunction getTaskEmails(taskId, emailsList) {\n  const taskEmails = emailsList\n    .filter(e => e.Id === taskId)\n    .map(e => e.email);\n  \n  return removeDuplicateEmails(taskEmails);\n}\n\n\nfunction enrichTask(task, executions, emails) {\n  const lastExecutions = getLastNExecutions(task.Id, executions, 3);\n  const enrichedPrompt = buildPromptWithHistory(task, lastExecutions);\n  const taskEmails = getTaskEmails(task.Id, emails);\n  \n  logTaskEnrichment(task, lastExecutions.length, taskEmails);\n  \n  return {\n    ...task,\n    Prompt: enrichedPrompt,\n    HistoryCount: lastExecutions.length,\n    Emails: taskEmails\n  };\n}\n\n\nfunction hasEmails(task) {\n  return task.Emails && task.Emails.length > 0;\n}\n\n\nfunction filterTasksWithEmails(tasks) {\n  return tasks.filter(task => {\n    if (!hasEmails(task)) {\n      console.log(`âš ï¸ Task \"${task.Subject}\" (ID: ${task.Id}) ignorada - sem emails configurados`);\n      return false;\n    }\n    return true;\n  });\n}\n\n\nfunction validateTasksExist(tasks) {\n  if (tasks.length === 0) {\n    console.log('\\nâŒ Nenhuma task com emails configurados. Finalizando fluxo.');\n    return false;\n  }\n  \n  console.log(`\\nâœ… ${tasks.length} task(s) com emails serÃ£o processadas`);\n  return true;\n}\n\n\nfunction filterTasksBySchedule(tasks, executions, today) {\n  return tasks.filter(task => {\n    const lastExecution = getLastExecution(task.Id, executions);\n    const shouldExecute = shouldExecuteTask(task, lastExecution, today);\n    \n    if (shouldExecute) {\n      console.log(`âœ… Task \"${task.Subject}\" deve ser executada`);\n    }\n    \n    return shouldExecute;\n  });\n}\n\n\nfunction logTaskEnrichment(task, historyCount, emails) {\n  console.log(`\\nðŸ“ Task \"${task.Subject}\" - HistÃ³rico: ${historyCount} execuÃ§Ãµes anteriores`);\n  console.log(`ðŸ“§ Emails: ${emails.length > 0 ? emails.join(', ') : 'nenhum'}`);\n}\n\n\nfunction logProcessingStats(tasksCount, executionsCount, emailsCount, today) {\n  console.log(`ðŸ“… Verificando tasks para: ${today.toLocaleDateString('pt-BR')}`);\n  console.log(`ðŸ“Š Total de tasks: ${tasksCount}`);\n  console.log(`ðŸ“Š Total de execuÃ§Ãµes: ${executionsCount}`);\n  console.log(`ðŸ“§ Total de emails configurados: ${emailsCount}`);\n}\n\n\nfunction filterTasksToExecute(tasks, executions, emails = [], today = new Date()) {\n  // Log de estatÃ­sticas iniciais\n  logProcessingStats(tasks.length, executions.length, emails.length, today);\n\n  // Filtrar tasks por agendamento\n  const scheduledTasks = filterTasksBySchedule(tasks, executions, today);\n  console.log(`\\nðŸŽ¯ Total de tasks para executar: ${scheduledTasks.length}`);\n\n  // Enriquecer tasks com histÃ³rico e emails\n  const enrichedTasks = scheduledTasks.map(task => \n    enrichTask(task, executions, emails)\n  );\n\n  // Filtrar apenas tasks com emails\n  const tasksWithEmails = filterTasksWithEmails(enrichedTasks);\n\n  // Validar se hÃ¡ tasks para processar\n  if (!validateTasksExist(tasksWithEmails)) {\n    return [];\n  }\n\n  return tasksWithEmails;\n}\n\n// Exportar todas as funÃ§Ãµes para testes\n\nconst tasksItems = $('GetTasks').all();\n  const executionsItems = $('GetExecutions').all();\n  const emailsItems = $('GetEmails').all();\n\n  \n  const tasks = tasksItems.map(item => item.json);\n  const executions = executionsItems.map(item => item.json);\n  const emails = emailsItems.map(item => item.json);\n\n  \n  const tasksToProcess = filterTasksToExecute(tasks, executions, emails);\n\n  \n  return tasksToProcess.map((task, index) => ({\n    json: task,\n    pairedItem: { item: index }\n  }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -272,
        -16
      ],
      "id": "76aaf292-360f-4b8a-a0f1-67cb214ac140",
      "name": "FilterTasksToBeExecuted"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash",
          "mode": "list",
          "cachedResultName": "models/gemini-2.5-flash"
        },
        "messages": {
          "values": [
            {
              "content": "={{ $json.Prompt }}"
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [
        -96,
        -16
      ],
      "id": "6df3cfc6-bd45-4706-a195-86c22df02471",
      "name": "AI-Process",
      "credentials": {
        "googlePalmApi": {
          "id": "xg8JJT12sq4nKGDw",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "function createTaskForEmail(task, email, allEmails) {\n  return {\n    ...task,\n    currentEmail: email,\n    allEmails: allEmails.join(', ')\n  };\n}\n\n\nfunction hasEmails(task) {\n  const emails = task.Emails || [];\n  return emails.length > 0;\n}\n\n\nfunction splitTaskByEmails(task) {\n  const emails = task.Emails || [];\n  \n  if (!hasEmails(task)) {\n    console.log(`âš ï¸ Task \"${task.Subject}\" (ID: ${task.Id}) nÃ£o tem emails configurados`);\n    return [];\n  }\n  \n  const splitItems = emails.map(email => \n    createTaskForEmail(task, email, emails)\n  );\n  \n  console.log(`ðŸ“§ Task \"${task.Subject}\" dividida para ${emails.length} email(s)`);\n  \n  return splitItems;\n}\n\n\nfunction splitByEmails(tasks) {\n  const splitItems = [];\n  \n  tasks.forEach(task => {\n    const taskSplitItems = splitTaskByEmails(task);\n    splitItems.push(...taskSplitItems);\n  });\n  \n  console.log(`\\nâœ… Total de emails a enviar: ${splitItems.length}`);\n  \n  return splitItems;\n}\n\n// Exportar todas as funÃ§Ãµes para testes\n\nconst items = $input.all();\n  \n  \n  const tasks = items.map(item => item.json);\n  \n  \n  const splitItems = splitByEmails(tasks);\n  \n  \n  return splitItems.map((item, index) => ({\n    json: item,\n    pairedItem: { item: index }\n  }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        240,
        -16
      ],
      "id": "d1286c63-b883-46a9-bac3-61f47a01b46b",
      "name": "SplitByEmails"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1Gav5wJnn-w-SffIATp_OVKfDdiIbE3AIPqxvZD8_zTI",
          "mode": "list",
          "cachedResultName": "n8n-database",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Gav5wJnn-w-SffIATp_OVKfDdiIbE3AIPqxvZD8_zTI/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 136723104,
          "mode": "list",
          "cachedResultName": "executions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Gav5wJnn-w-SffIATp_OVKfDdiIbE3AIPqxvZD8_zTI/edit#gid=136723104"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Id": "={{ $('FilterTasksToBeExecuted').item.json.Id }}",
            "ExecutionTime": "={{ $now.format('dd/MM/yyyy HH:mm:ss') }}",
            "Saida": "={{ $json.content.parts[0].text }}",
            "Emails": "={{ $json.allEmails }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "Id",
              "displayName": "Id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ExecutionTime",
              "displayName": "ExecutionTime",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Saida",
              "displayName": "Saida",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Emails",
              "displayName": "Emails",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        464,
        -16
      ],
      "id": "6fb454c1-10b2-4325-b122-e5a2ff81748b",
      "name": "AppendExecutions",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "TcsAIidzUoiqPfyA",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1Gav5wJnn-w-SffIATp_OVKfDdiIbE3AIPqxvZD8_zTI",
          "mode": "list",
          "cachedResultName": "n8n-database",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Gav5wJnn-w-SffIATp_OVKfDdiIbE3AIPqxvZD8_zTI/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1041026492,
          "mode": "list",
          "cachedResultName": "emails",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Gav5wJnn-w-SffIATp_OVKfDdiIbE3AIPqxvZD8_zTI/edit#gid=1041026492"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -496,
        -16
      ],
      "id": "bc637093-e099-4437-9396-c81ebad0a93a",
      "name": "GetEmails",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "TcsAIidzUoiqPfyA",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "sendTo": "={{ $json.currentEmail }}",
        "subject": "={{ $json.Subject }}",
        "message": "={{ $json.content.parts[0].text }}",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        672,
        -16
      ],
      "id": "a5a05be0-bbbd-4267-bd6f-73cac4704ba6",
      "name": "SendEmail",
      "webhookId": "9d836195-3a6d-48a7-a95f-ef9a5c055267",
      "credentials": {
        "gmailOAuth2": {
          "id": "Mx40O4DWSK5YGsKn",
          "name": "Gmail account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "GetTasks",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GetTasks": {
      "main": [
        [
          {
            "node": "GetExecutions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GetExecutions": {
      "main": [
        [
          {
            "node": "GetEmails",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FilterTasksToBeExecuted": {
      "main": [
        [
          {
            "node": "AI-Process",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI-Process": {
      "main": [
        [
          {
            "node": "SplitByEmails",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SplitByEmails": {
      "main": [
        [
          {
            "node": "AppendExecutions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AppendExecutions": {
      "main": [
        [
          {
            "node": "SendEmail",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GetEmails": {
      "main": [
        [
          {
            "node": "FilterTasksToBeExecuted",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false,
    "errorWorkflow": "HOB5DNjfjjnwHLUg",
    "executionTimeout": 3600,
    "timeSavedPerExecution": 30
  },
  "versionId": "d30ed601-a5c7-42cf-ac99-b2bcfbed74f2",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "c4d6a8d4fd80a8d9138c380c50a14cd195951e4a2b31f687a6d6dc7a33dd0c5c"
  },
  "id": "HOB5DNjfjjnwHLUg",
  "tags": []
}